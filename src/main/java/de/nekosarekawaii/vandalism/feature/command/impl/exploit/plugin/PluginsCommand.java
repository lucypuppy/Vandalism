/*
 * This file is part of Vandalism - https://github.com/NekosAreKawaii/Vandalism
 * Copyright (C) 2023-2024 NekosAreKawaii, FooFieOwO, Verschlxfene, Recyz and contributors
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

package de.nekosarekawaii.vandalism.feature.command.impl.exploit.plugin;

import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import com.mojang.brigadier.suggestion.Suggestion;
import de.nekosarekawaii.vandalism.Vandalism;
import de.nekosarekawaii.vandalism.event.network.IncomingPacketListener;
import de.nekosarekawaii.vandalism.feature.command.AbstractCommand;
import de.nekosarekawaii.vandalism.util.ChatUtil;
import joptsimple.internal.Strings;
import net.minecraft.command.CommandSource;
import net.minecraft.network.packet.c2s.play.RequestCommandCompletionsC2SPacket;
import net.minecraft.network.packet.s2c.play.CommandSuggestionsS2CPacket;
import net.minecraft.util.Formatting;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.Executors;

public class PluginsCommand extends AbstractCommand implements IncomingPacketListener {

    private boolean running, received = false;

    private static final String BUKKIT_COMMAND_PREFIX = "bukkit:";

    private static final String[] COMMANDS = new String[]{
            "about",
            "version",
            "ver",
            "?",
            "split"
    };

    public PluginsCommand() {
        super(
                "Lets you view the plugins the server.",
                Category.EXPLOIT,
                "pl",
                "plugins",
                "viewplugins",
                "showplugins"
        );
    }

    @Override
    public void build(final LiteralArgumentBuilder<CommandSource> builder) {
        builder.executes(context -> {
            this.sendPacket(COMMANDS[0]);
            return SINGLE_SUCCESS;
        });
        for (final String command : COMMANDS) {
            builder.then(literal(command)
                    .executes(context -> {
                        this.sendPacket(command);
                        return SINGLE_SUCCESS;
                    })
            );
            if (!command.equals("split")) {
                builder.then(literal(BUKKIT_COMMAND_PREFIX + command)
                        .executes(context -> {
                            this.sendPacket(BUKKIT_COMMAND_PREFIX + command);
                            return SINGLE_SUCCESS;
                        })
                );
            }
        }
    }

    private void sendPacket(final String command) {
        if (this.running) {
            ChatUtil.errorChatMessage("Plugins check already running!");
            return;
        }
        this.running = true;
        this.received = false;
        if (this.mc.getNetworkHandler() == null) return;
        Vandalism.getInstance().getEventSystem().subscribe(IncomingPacketEvent.ID, this);
        Executors.newSingleThreadExecutor().submit(() -> {
            try {
                Thread.sleep(2500);
            } catch (InterruptedException ignored) {
            }
            Vandalism.getInstance().getEventSystem().unsubscribe(IncomingPacketEvent.ID, this);
            this.running = false;
            if (!this.received) ChatUtil.errorChatMessage("Plugins check timed out!");
        });
        this.mc.getNetworkHandler().sendPacket(new RequestCommandCompletionsC2SPacket(
                this.mc.getNetworkHandler().getCommandSource().completionId + 1,
                "/" + command + (command.equals("split") ? "" : " ")
        ));
    }

    @Override
    public void onIncomingPacket(final IncomingPacketEvent event) {
        if (event.packet instanceof final CommandSuggestionsS2CPacket commandSuggestionsS2CPacket) {
            final List<Suggestion> list = commandSuggestionsS2CPacket.getSuggestions().getList();
            if (!list.isEmpty()) {
                this.received = true;
                final List<String> plugins = new ArrayList<>();
                for (final Suggestion entry : list) {
                    String pluginName = entry.getText();
                    boolean cantAdd = true;
                    if (pluginName.contains("/")) pluginName = pluginName.replace("/", "");
                    if (pluginName.contains(":")) {
                        final String[] commandData = pluginName.split(":");
                        if (commandData.length > 1) {
                            pluginName = commandData[0];
                            cantAdd = false;
                        }
                    } else if (Character.isUpperCase(pluginName.charAt(0))) {
                        cantAdd = false;
                    }
                    if (!cantAdd && !plugins.contains(pluginName)) plugins.add(pluginName);
                }
                if (!plugins.isEmpty()) {
                    Collections.sort(plugins);
                    ChatUtil.infoChatMessage(
                            Formatting.WHITE + "Plugins (" + plugins.size() + "): " +
                            Formatting.GREEN + Strings.join(plugins.toArray(String[]::new),
                            Formatting.WHITE + ", " + Formatting.GREEN)
                    );
                } else ChatUtil.errorChatMessage("No plugins found!");
            }
        }
    }

}
