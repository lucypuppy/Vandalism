package de.vandalismdevelopment.vandalism.feature.impl.module.impl.exploit;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.mojang.authlib.GameProfile;
import com.mojang.authlib.properties.PropertyMap;
import de.florianmichael.dietrichevents2.DietrichEvents2;
import de.vandalismdevelopment.vandalism.event.PacketListener;
import de.vandalismdevelopment.vandalism.feature.FeatureCategory;
import de.vandalismdevelopment.vandalism.feature.impl.module.Module;
import de.vandalismdevelopment.vandalism.value.Value;
import de.vandalismdevelopment.vandalism.value.impl.BooleanValue;
import de.vandalismdevelopment.vandalism.value.impl.StringValue;
import net.minecraft.network.NetworkState;
import net.minecraft.network.packet.c2s.handshake.HandshakeC2SPacket;

import java.util.concurrent.ThreadLocalRandom;

public class BungeeCordSpooferModule extends Module implements PacketListener {

    private final Value<Boolean> customizeIP = new BooleanValue("Customize IP", "Allows you to define the ip by your-self.", this, false);

    private final Value<String> ip = new StringValue("IP", "The IP that will be used.", this, "127.0.0.1").visibleConsumer(this.customizeIP::getValue);

    private final Value<Boolean> sendMoreData = new BooleanValue("Send More Data", "Sends everything BungeeCord would send.", this, false);

    private final static Gson GSON = new GsonBuilder().registerTypeAdapter(PropertyMap.class, new PropertyMap.Serializer()).create();

    public BungeeCordSpooferModule() {
        super("Bungee Cord Spoof", "Allows you to connect to a bungee cord sub server.", FeatureCategory.EXPLOIT, false, false);
    }

    @Override
    protected void onEnable() {
        DietrichEvents2.global().subscribe(PacketEvent.ID, this);
    }

    @Override
    protected void onDisable() {
        DietrichEvents2.global().unsubscribe(PacketEvent.ID, this);
    }

    private String getRandomIpPart() {
        return String.valueOf(ThreadLocalRandom.current().nextInt(256));
    }

    @Override
    public void onPacket(final PacketEvent event) {
        if (event.packet instanceof final HandshakeC2SPacket handshakeC2SPacket) {
            if (handshakeC2SPacket.getNewNetworkState() == NetworkState.LOGIN) {
                if (this.sendMoreData.getValue()) {
                    final String address;
                    if (this.customizeIP.getValue()) address = this.ip.getValue();
                    else address = this.getRandomIpPart() + "." + this.getRandomIpPart() + "." + this.getRandomIpPart() + "." + this.getRandomIpPart();

                    final GameProfile profile = this.mc().getGameProfile();
                    String newAddress = address + "\00" + address + "\00" + profile.getId().toString();
                    if (profile.getProperties() != null && !profile.getProperties().isEmpty())
                        newAddress += "\00" + GSON.toJson(profile.getProperties());

                    handshakeC2SPacket.address = newAddress;
                } else {
                    handshakeC2SPacket.address += "\u0000";
                    if (this.customizeIP.getValue())
                        handshakeC2SPacket.address = this.ip.getValue();
                     else
                        handshakeC2SPacket.address += this.getRandomIpPart() + "." + this.getRandomIpPart() + "." + this.getRandomIpPart() + "." + this.getRandomIpPart();

                    handshakeC2SPacket.address += "\u0000" + this.mc().session.getUuidOrNull().toString().replace("-", "");
                }
            }
        }
    }

}