package de.vandalismdevelopment.vandalism.feature.impl.command.impl.exploit;

import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import com.mojang.brigadier.suggestion.Suggestion;
import de.florianmichael.dietrichevents2.DietrichEvents2;
import de.vandalismdevelopment.vandalism.base.event.PacketListener;
import de.vandalismdevelopment.vandalism.feature.FeatureCategory;
import de.vandalismdevelopment.vandalism.feature.impl.command.Command;
import de.vandalismdevelopment.vandalism.util.minecraft.impl.ChatUtil;
import joptsimple.internal.Strings;
import net.minecraft.command.CommandSource;
import net.minecraft.network.packet.c2s.play.RequestCommandCompletionsC2SPacket;
import net.minecraft.network.packet.s2c.play.CommandSuggestionsS2CPacket;
import net.minecraft.util.Formatting;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.Executors;

public class PluginsCommand extends Command implements PacketListener {

    private boolean running, received = false;

    private static final String BUKKIT_COMMAND_PREFIX = "bukkit:";

    private static final String[] COMMANDS = new String[]{
            "about",
            "version",
            "ver",
            "?",
            "normal"
    };

    public PluginsCommand() {
        super(
                "Plugins",
                "Lets you view the plugins the server.",
                FeatureCategory.EXPLOIT,
                false,
                "pl",
                "plugins",
                "viewplugins",
                "showplugins"
        );
    }

    @Override
    public void build(final LiteralArgumentBuilder<CommandSource> builder) {
        for (final String command : COMMANDS) {
            builder.then(literal(command)
                    .executes(context -> {
                        this.sendPacket(command);
                        return SINGLE_SUCCESS;
                    })
            );

            if (!command.equals("normal")) {
                builder.then(literal(BUKKIT_COMMAND_PREFIX + command)
                        .executes(context -> {
                            this.sendPacket(BUKKIT_COMMAND_PREFIX + command);
                            return SINGLE_SUCCESS;
                        })
                );
            }
        }
    }

    private void sendPacket(final String command) {
        if (this.running) {
            ChatUtil.errorChatMessage("Plugins check already running!");
            return;
        }
        this.running = true;
        this.received = false;
        if (this.networkHandler() == null) return;
        DietrichEvents2.global().subscribe(PacketEvent.ID, this);
        Executors.newSingleThreadExecutor().submit(() -> {
            try {
                Thread.sleep(2500);
            }
            catch (final InterruptedException ignored) {}
            DietrichEvents2.global().unsubscribe(PacketEvent.ID, this);
            this.running = false;
            if (!this.received) ChatUtil.errorChatMessage("Plugins check timed out!");
        });
        this.networkHandler().sendPacket(new RequestCommandCompletionsC2SPacket(
                this.networkHandler().getCommandSource().completionId + 1,
                "/" + command + (command.equals("normal") ? "" : " ")
        ));
    }

    @Override
    public void onPacket(final PacketEvent event) {
        if (event.packet instanceof final CommandSuggestionsS2CPacket commandSuggestionsS2CPacket) {
            final List<Suggestion> list = commandSuggestionsS2CPacket.getSuggestions().getList();
            if (!list.isEmpty()) {
                this.received = true;
                final List<String> plugins = new ArrayList<>();
                for (final Suggestion entry : list) {
                    String pluginName = entry.getText();
                    boolean cantAdd = true;
                    if (pluginName.contains("/")) pluginName = pluginName.replace("/", "");
                    if (pluginName.contains(":")) {
                        final String[] commandData = pluginName.split(":");
                        if (commandData.length > 1) {
                            pluginName = commandData[0];
                            cantAdd = false;
                        }
                    } else if (Character.isUpperCase(pluginName.charAt(0))) {
                        cantAdd = false;
                    }
                    if (!cantAdd && !plugins.contains(pluginName)) plugins.add(pluginName);
                }
                if (!plugins.isEmpty()) {
                    Collections.sort(plugins);
                    ChatUtil.infoChatMessage(Formatting.WHITE + "Plugins (" + plugins.size() + "): " + Formatting.GREEN + Strings.join(plugins.toArray(String[]::new), Formatting.WHITE + ", " + Formatting.GREEN));
                } else ChatUtil.errorChatMessage("No Plugins found!");
            }
        }
    }

}
